name: Docker Image CI

on:
  push:
    branches: [ "master", "github-action-workflow" ]
  pull_request:
    branches: [ "master", "github-action-workflow" ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build and test
      run: |
        dotnet build
        dotnet test
        
    - name: Publish and create Docker image
      run: |
        dotnet publish -c Release -o out
        docker build . --file Dockerfile --tag visualbam/withbruce:$(date +%s)
 
  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v3
      
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          version: v2.3.0
          
      - name: Configure doctl
        run: doctl auth init --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          
      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install docker-compose
          
      - name: Deploy to staging
        run: |
          docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} -p ${{ secrets.DOCKER_HUB_PASSWORD }}
          doctl compute ssh withbruce
          cd apps/withbruce
          docker-compose -f docker-compose.yml up -d  
